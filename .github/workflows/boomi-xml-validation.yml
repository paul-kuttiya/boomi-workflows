name: Boomi XML Validation

on:
  pull_request:
    paths:
      - "boomi-processes/**/*.xml"

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate Boomi process XMLs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set up Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: "3.12"

      - name: Get changed XML files
        id: changed
        uses: tj-actions/changed-files@v47.0.1
        with:
          files: |
            boomi-processes/**/*.xml

      - name: Show changed files
        run: |
          echo "Changed XML files:"
          for f in ${{ steps.changed.outputs.all_changed_files }}; do
            echo " - $f"
          done

      - name: Run validation
        id: validate
        if: steps.changed.outputs.any_changed == 'true'
        run: |
          # Always create a results file, even if validation fails
          set +e
          python scripts/validate_boomi_xml.py ${{ steps.changed.outputs.all_changed_files }}
          status=$?
          if [ ! -f boomi-xml-validation-results.md ]; then
            echo "## ðŸ« Boomi XML Validation Results" > boomi-xml-validation-results.md
            echo "" >> boomi-xml-validation-results.md
            echo "**Status:** âŒ Validation failed (exit code $status) and no report was generated." >> boomi-xml-validation-results.md
          fi
          exit $status
        env:
          # Write to GitHub Step Summary
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}

      - name: No XML changes detected
        if: steps.changed.outputs.any_changed != 'true'
        run: |
          echo "No boomi-processes/**/*.xml files changed; skipping validation."

      - name: Post validation results to PR
        if: always() && github.event_name == 'pull_request' && steps.changed.outputs.any_changed == 'true'
        uses: marocchino/sticky-pull-request-comment@v2.9.1
        with:
          header: boomi-xml-validation
          path: boomi-xml-validation-results.md
